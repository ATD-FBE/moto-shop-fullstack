/services
  /storage
    storageService.js
    /providers
      fs.provider.js
      s3.provider.js

========================================

fsStorage.provider.js — файловая система
// services/storage/fsStorage.provider.js

import fs from 'fs/promises';
import path from 'path';

const PRODUCTS_DIR = path.resolve('uploads/products');

export const fsStorageProvider = {
    supports: {
        directories: true
    },

    async saveProductImage({ productId, file }) {
        const productDir = path.join(PRODUCTS_DIR, productId);

        await fs.mkdir(productDir, { recursive: true });

        const filePath = path.join(productDir, file.originalname);

        await fs.writeFile(filePath, file.buffer);

        return {
            url: `/uploads/products/${productId}/${file.originalname}`,
            storagePath: filePath
        };
    },

    async deleteProductImage({ productId, filename }) {
        const filePath = path.join(PRODUCTS_DIR, productId, filename);
        const productDir = path.join(PRODUCTS_DIR, productId);

        await fs.unlink(filePath);

        // чистим папку, если пустая
        const files = await fs.readdir(productDir);
        if (files.length === 0) {
            await fs.rmdir(productDir);
        }
    },

    async cleanEmptyFolder(productId) {
        const dir = path.join(UPLOAD_ROOT, 'products', productId);
        const files = await fs.promises.readdir(dir);

        if (files.length === 0) {
            await fs.promises.rmdir(dir);
        }
    }
};

========================================

s3Storage.provider.js — облачное хранилище
// services/storage/s3Storage.provider.js

import { s3Client, PutObjectCommand, DeleteObjectCommand } from '../s3Client.js';

const BUCKET = process.env.S3_BUCKET;

export const s3StorageProvider = {
    supports: {
        directories: false
    },

    async saveProductImage({ productId, file }) {
        const key = `products/${productId}/${file.originalname}`;

        await s3Client.send(
            new PutObjectCommand({
                Bucket: BUCKET,
                Key: key,
                Body: file.buffer,
                ContentType: file.mimetype
            })
        );

        return {
            url: `https://${BUCKET}.s3.amazonaws.com/${key}`,
            storagePath: key
        };
    },

    async deleteProductImage({ productId, filename }) {
        const key = `products/${productId}/${filename}`;

        await s3Client.send(
            new DeleteObjectCommand({
                Bucket: BUCKET,
                Key: key
            })
        );
    }
};

========================================

storageService.js — оркестратор (один if, один раз)
// services/storage/storageService.js

import { fsStorageProvider } from './fsStorage.provider.js';
import { s3StorageProvider } from './s3Storage.provider.js';

const STORAGE_TYPE = process.env.STORAGE_TYPE;

let provider;

switch (STORAGE_TYPE) {
    case 'fs':
        provider = fsStorageProvider;
        break;
    case 's3':
        provider = s3StorageProvider;
        break;
    default:
        throw new Error(`Unknown STORAGE_TYPE: ${STORAGE_TYPE}`);
}

export const storageService = {
    supports: provider.supports,
    saveProductImage: provider.saveProductImage,
    deleteProductImage: provider.deleteProductImage
};

========================================

Использование в сервисе товара (одинаково для всех хранилищ)
// services/productImages.service.js

import { storageService } from './storage/storageService.js';

export async function addProductImage({ productId, file }) {
    const image = await storageService.saveProductImage({
        productId,
        file
    });

    // ...

    if (storageService.supports.directories) {
        await storageService.cleanEmptyFolder(productId);
    }

    // тут только бизнес-логика
    // image.url → в БД
    // image.storagePath → для удаления

    return image;
}
